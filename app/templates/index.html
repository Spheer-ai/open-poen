{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import 'macros.html' as macros %}
{% set active_page = "Home" %}
{% block head %}
<title>Open Poen</title>
<meta property="og:title" content="Open Poen" />
{{ super() }}
{% endblock %}

{% block body %}

<body onresize="createDonuts()" class="bg-grey home{% if use_square_borders %} use-square-borders{% endif %}">
  {% endblock %}

  {% block content %}
  <div class="container poen-lead {% if background %}background{% endif %} index-lead bg-grey-light">
    <div class="row">
      <div class="col-12 col-md-6 header-logo text-center">
        <img class="index-lead-logo img-fluid" src="{{ url_for('static', filename='images/Open-Poen-Logo-2.svg') }}"
          alt="Open Poen logo">
      </div>
      <div class="col-12 col-md-6 my-auto text-center text-md-left">
        {% if tagline %}{{ tagline|safe }}{% endif %}
        <br>
        <button type="button" class="btn button-poen bg-white">
          <h2><a href="{{ url_for('meest_gestelde_vragen') }}">bekijk hoe het werkt ></a></h2>
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-12 col-lg-10 offset-lg-1 poen-content bg-white">
        <div class="row">
          <div class="col-4 border-r small-gutter-right">
            <h4>
              €
              {% if project_data|length > 0 %}
              {{ total_spent_str }}
              {% else %}
              0
              {% endif %}
            </h4>
            <h2>totaal uitgegeven</h2>
          </div>
          <div class="col-4 text-center small-gutter">
            <h4 class="text-red">{{ project_data|length }}</h4>
            {% if project_data|length == 1 %}
            <h2>buurtinitiatief</h2>
            {% else %}
            <h2>buurtinitiatieven</h2>
            {% endif %}
          </div>
          <div class="col-4 text-right border-l small-gutter-left">
            <h4 class="text-blue-light">
              €
              {% if project_data|length > 0 %}
              {{ total_awarded_str }}
              {% else %}
              0
              {% endif %}
            </h4>
            <h2>totaal toegekend</h2>
          </div>

          <hr>
          <br>
        </div>

        <hr class="index-hr-top">

        <div class="row">
          {% if current_user.admin %}
          <div class="col-12 col-md-6 col-xxl-4">
            <div class="row">
              <div class="col-12">
                <!-- Button trigger modal -->
                <button type="button" class="btn amounts-half-card w-100 bg-green-light text-white" data-toggle="modal"
                  data-target="#admins-beheren">
                  <h1>admins beheren</h1>
                  <h5>+</h5>
                </button>

                <!-- Modal -->
                <div class="modal fade" id="admins-beheren" tabindex="-1" role="dialog"
                  aria-labelledby="adminsBeherenLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="adminsBeherenLabel">Admins Beheren</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Annuleren">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <div>
                          <!-- Button trigger modal -->
                          <button type="button" class="btn button-poen-small bg-grey-blue" data-toggle="modal"
                            data-target="#admin-toevoegen">
                            admin toevoegen
                          </button>

                          <button type="button" class="btn button-poen-small bg-grey-blue" data-toggle="modal"
                            data-target="#financial-toevoegen">
                            financial toevoegen
                          </button>

                          <!-- Modal -->
                          <div class="modal fade" id="admin-toevoegen" tabindex="-1" role="dialog"
                            aria-labelledby="adminToevoegenLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <form method="POST">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="adminToevoegenLabel">Admin Toevoegen</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Annuleren">
                                      <span aria-hidden="true">&times;</span>
                                    </button>
                                  </div>
                                  <div class="modal-body">
                                    <p>Als er nog geen gebruiker bestaat met dit e-mailadres dan krijgt deze een
                                      uitnodigingsmail met daarin een link om een wachtwoord aan te maken. Als er wel al
                                      een gebruiker bestaat met dit e-mailadres dan krijgt deze gebruiker admin-rechten
                                      (er wordt daar geen e-mail over verstuurd).</p>
                                    <div>
                                      {{ add_user_form.csrf_token }}

                                      {{ wtf.form_field(add_user_form.email, class="form-control") }}
                                      {{ add_user_form.admin(**{'value': 1}) }}
                                    </div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                      data-dismiss="modal">Annuleren</button>
                                    {{ add_user_form.submit }}
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>

                          <div class="modal fade" id="financial-toevoegen" tabindex="-1" role="dialog"
                            aria-labelledby="financialToevoegenLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <form method="POST">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="financialToevoegenLabel">Financial Toevoegen</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Annuleren">
                                      <span aria-hidden="true">&times;</span>
                                    </button>
                                  </div>
                                  <div class="modal-body">
                                    <p>Als er nog geen gebruiker bestaat met dit e-mailadres dan krijgt deze een
                                      uitnodigingsmail met daarin een link om een wachtwoord aan te maken. Als er wel al
                                      een gebruiker bestaat met dit e-mailadres dan krijgt deze gebruiker
                                      financial-rechten
                                      (er wordt daar geen e-mail over verstuurd).</p>
                                    <div>
                                      {{ add_user_form.csrf_token }}

                                      {{ wtf.form_field(add_user_form.email, class="form-control") }}
                                      {{ add_user_form.financial(**{'value': 1}) }}
                                    </div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                      data-dismiss="modal">Annuleren</button>
                                    {{ add_user_form.submit }}
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>

                          <hr>

                          {% for admin_email, edit_admin_form in edit_admin_forms.items() %}
                          <div>
                            <!-- Button trigger modal -->
                            <button type="button" class="btn button-poen-small bg-grey-blue" data-toggle="modal"
                              data-target="#admin-beheren-{{ edit_admin_form.id.data }}">
                              admin beheren
                            </button>
                            {{ admin_email }}

                            <!-- Modal -->
                            <div class="modal fade" id="admin-beheren-{{ edit_admin_form.id.data }}" tabindex="-1"
                              role="dialog" aria-labelledby="adminbeherenLabel" aria-hidden="true">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                  <form method="POST">
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="adminbeherenLabel">Admin beheren</h5>
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Annuleren">
                                        <span aria-hidden="true">&times;</span>
                                      </button>
                                    </div>
                                    <div class="modal-body">
                                      <div>
                                        {{ edit_admin_form.csrf_token }}

                                        {% for f in edit_admin_form %}
                                        {% if f.widget.input_type != 'hidden' and f.widget.input_type != 'submit' %}
                                        {{ wtf.form_field(f, class="form-control") }}
                                        {% endif %}
                                        {% endfor %}
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary"
                                        data-dismiss="modal">Annuleren</button>
                                      {{ edit_admin_form.id }}
                                      {{ edit_admin_form.submit }}
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          </div>
                          <br>
                          {% endfor %}
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuleren</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <!-- Button trigger modal -->
                <button type="button" class="btn amounts-half-card w-100 bg-green-light text-white" data-toggle="modal"
                  data-target="#modal-project-toevoegen">
                  <h1>initiatief toevoegen</h1>
                  <h5>+</h5>
                </button>

                <!-- Modal -->
                <div class="modal fade" id="modal-project-toevoegen" tabindex="-1" role="dialog"
                  aria-labelledby="projectToevoegenLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <form method="POST" class="interactive-form" novalidate>
                        <div class="modal-header">
                          <h5 class="modal-title" id="projectToevoegenLabel">Initiatief Toevoegen</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Annuleren">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <div>
                            {{ project_form.csrf_token }}
                            <div class="interactive-unit">
                              <h2>Over initiatief</h2>
                              <hr>
                              {{ wtf.form_field(project_form.name) }}
                              {{ wtf.form_field(project_form.description) }}
                              {{ wtf.form_field(project_form.purpose) }}
                              {{ wtf.form_field(project_form.target_audience) }}
                              {{ wtf.form_field(project_form.hidden) }}
                              {{ wtf.form_field(project_form.contains_subprojects) }}
                            </div>
                            <div class="interactive-unit">
                              <h2>Sponsor(s) initiatief</h2>
                              <hr>
                              <div class="funder_all">
                                {% for funder in project_form.funders %}
                                <div class="funder" id="funder-{{loop.index - 1}}">
                                  {{ wtf.form_field(funder.form.name) }}
                                  {{ wtf.form_field(funder.form.subsidy) }}
                                  {{ wtf.form_field(funder.form.subsidy_number) }}
                                  {{ wtf.form_field(funder.form.budget) }}
                                  {{ wtf.form_field(funder.form.url) }}
                                  {{ macros.trashbin('#funder-', loop.index - 1) }}
                                  <hr>
                                </div>
                                {% endfor %}
                              </div>
                              {{ macros.plussign("funder", "Sponsor") }}
                              {{ wtf.form_field(project_form.hidden_sponsors) }}
                            </div>
                            <div class="interactive-unit">
                              <h2>Betaalpas(sen) initiatief</h2>
                              <hr>
                              <div class="card_number_all">
                                {% for card_number in project_form.card_numbers %}
                                <div class="card_number" , id="card_number-{{loop.index - 1}}">
                                  <div style="display: flex">
                                    {{ wtf.form_field(card_number.form.card_number, class="form-control-sm",
                                    form_type="inline") }}
                                    {{ macros.trashbin('#card_number-', loop.index - 1, True) }}
                                  </div>
                                  {{ macros.render_single_field_field_list_errors(card_number) }}
                                </div>
                                {% endfor %}
                              </div>
                              {{ macros.plussign("card_number", "betaalpas") }}
                            </div>
                            <div class="interactive-unit">
                              <h2>Activiteiten initiatief</h2>
                              <hr>
                              <div class="subproject_all">
                                {% for subproject in project_form.subprojects %}
                                <div class="subproject" id="subproject-{{loop.index - 1}}">
                                  {{ wtf.form_field(subproject.form.name) }}
                                  {{ wtf.form_field(subproject.form.description) }}
                                  {{ wtf.form_field(subproject.form.purpose) }}
                                  {{ wtf.form_field(subproject.form.target_audience) }}
                                  {{ wtf.form_field(subproject.form.hidden) }}
                                  {{ wtf.form_field(subproject.form.budget) }}
                                  {{ macros.trashbin("#subproject-", loop.index -1) }}
                                  <hr>
                                </div>
                                {% endfor %}
                              </div>
                              {{ macros.plussign("subproject", "activiteit") }}
                            </div>
                            <div class="interactive-unit">
                              <h2>Gegevens initiatief</h2>
                              <hr>
                              {{ wtf.form_field(project_form.owner) }}
                              {{ wtf.form_field(project_form.owner_email) }}
                              <label class="control-label">Initiatiefnemers</label>
                              <div class="project_owner_all">
                                {% for project_owner in project_form.project_owners %}
                                <div class="project_owner" id="project_owner-{{loop.index - 1}}">
                                  <div style="display: flex">
                                    {{ wtf.form_field(project_owner.email, class="form-control-sm", placeholder="email",
                                    form_type="inline") }}
                                    {{ macros.trashbin("#project_owner-", loop.index - 1, True) }}
                                  </div>
                                  {{ macros.render_single_field_field_list_errors(project_owner) }}
                                </div>
                                {% endfor %}
                              </div>
                              {{ macros.plussign("project_owner", "Activiteitnemer") }}
                              {{ wtf.form_field(project_form.legal_entity) }}
                              {{ wtf.form_field(project_form.address_applicant) }}
                              {{ wtf.form_field(project_form.registration_kvk) }}
                              {{ wtf.form_field(project_form.project_location) }}
                            </div>
                            <div class="interactive-unit">
                              <h2>Financiën initiatief</h2>

                              {{ wtf.form_field(project_form.budget) }}
                            </div>
                          </div>

                          {% if project_form.has_errors %}
                          <div>
                            <p style="color: red; margin-bottom: 0px;">Het formulier bevat fout(en).
                              Doorloop het formulier opnieuw en
                              volg
                              de
                              aanwijzingen op.
                            </p>
                          </div>
                          {% endif %}
                        </div>
                        <div class="modal-footer">
                          <button type="button" onclick="wizard.prev()"
                            class="btn btn-secondary interactive-prev">Vorige</button>
                          <button type="button" class="btn btn-danger" data-dismiss="modal">Annuleren</button>
                          {{ project_form.submit }}
                          <button type="button" onclick="wizard.next()"
                            class="btn btn-primary interactive-next">Volgende</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              {% if bng_info %}
              {% set bng_action = "Beheren" %}
              {% else %}
              {% set bng_action = "Aanmaken" %}
              {% endif %}
              <div class="col-12">
                <!-- Button trigger modal -->
                <button type="button" class="btn amounts-half-card w-100 bg-green-light text-white" data-toggle="modal"
                  data-target="#modal-bng-koppeling-beheren">
                  <h1>BNG-koppeling</h1>
                  <h1 style="margin-top: 15px">{{ bng_action }}</h1>
                </button>
                <!-- Modal -->
                <div class="modal fade" id="modal-bng-koppeling-beheren" tabindex="-1" role="dialog"
                  aria-labelledby="BNGKoppelingBeherenLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <form method="POST">
                        <div class="modal-header">
                          <h5 class="modal-title" id="BNGKoppelingBeherenLabel">BNG-koppeling {{ bng_action }}</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Annuleren">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <div>
                            {% if bng_info %}
                            <div class="bng-info-unit">
                              <i class="fas fa-link fa-2x fa-fw" style="color: {{ bng_info['created']['color'] }}"></i>
                              <p>{{ bng_info["created"]["message"] }}</p>
                            </div>
                            <div class="bng-info-unit">
                              <i class="fas fa-wifi fa-2x fa-fw" style="color: {{ bng_info['status']['color'] }}"></i>
                              <p>{{ bng_info["status"]["message"] }}</p>
                            </div>
                            <div class="bng-info-unit">
                              <i class="fas fa-check-circle fa-2x fa-fw"
                                style="color: {{ bng_info['days_left']['color'] }}"></i>
                              <p>{{ bng_info["days_left"]["message"] }}</p>
                            </div>
                            <div class="bng-info-unit">
                              <i class="fas fa-sync-alt fa-2x fa-fw" style="color: {{ bng_info['sync']['color'] }}"></i>
                              <p>{{ bng_info["sync"]["message"] }}</p>
                            </div>
                            {% else %}
                            <p>Voeg hier de IBAN toe van de rekening die je wil koppelen en de datum tot wanneer je wilt
                              dat de koppeling geldig blijft.</p>
                            {% for f in bng_link_form %}
                            {% if f.widget.input_type != 'hidden' and f.widget.input_type != 'submit' and f.name !=
                            "bng_link_form-valid_until" %}
                            {{ wtf.form_field(f, class="form-control") }}
                            {% endif %}
                            {% if f.name == "bng_link_form-valid_until" %}
                            {{ wtf.form_field(f, class="form-control datepicker") }}
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {{ bng_link_form.csrf_token }}
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            {{ "Terug" if bng_info else "Annuleren" }}
                          </button>
                          {% if not bng_info %}
                          {{ bng_link_form.submit }}
                          {% else %}
                          {{ bng_link_form.remove }}
                          {% endif %}
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if project_data %}
          {% for project in project_data %}
          <div class="col-12 col-md-6 col-xxl-4">
            <a class="card-button" role="button" href="{{ url_for('project', project_id=project.id) }}">
              <div class="amounts-card bg-green-light">
                {% if project.hidden %}
                <p><i>Dit initiatief is verborgen en dus niet te zien door het publiek</i>
                <p>
                  {% endif %}
                <div class="amounts-card-title">
                  <h1 class="text-center">{{ project.name }}</h1>
                </div>
                <div class="row">
                  <div class="col-4 text-right small-gutter">
                    <br>
                    <h3 class="text-blue">resterend</h3>
                    <h2>{{ project.amounts.left_str }}</h2>
                  </div>
                  <div class="col-4 text-center donut" data-percentage="{{ project.amounts.percentage_spent_str }}">
                  </div>
                  <div class="col-4 small-gutter">
                    <br>
                    <h3 class="text-red">uitgegeven</h3>
                    <h2>{{ project.amounts.spent_str }}</h2>
                  </div>
                </div>
                {% if project.budget %}
                <h3 class="text-center totaal">budget {{ project.budget }}</h3>
                <p class="text-center">waarvan ontvangen {{ project.amounts.awarded_str }}</p>
                {% else %}
                <h3 class="text-center totaal">ontvangen inkomsten {{ project.amounts.awarded_str }}</h3>
                {% endif %}
              </div>
            </a>
          </div>
          {% endfor %}
          {% endif %}
        </div>

        {% if user_stories %}
        <br>
        <hr>
        <br>
        <b>de mensen over open poen</b>
        {% for user_story in user_stories %}
        <p>{{ user_story.name }}</p>
        <p>{{ user_story.title }}</p>
        {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
  </div>
  {% endblock %}
  {% block scripts %}
  {% if modal_id is not none %}
  <script>
    window.modal_id = {{ modal_id | safe }};
  </script>
  {% endif %}
  {{ super() }}
  <script>
    window.wizard = new FormWizard(".interactive-form")
  </script>
  {% endblock %}